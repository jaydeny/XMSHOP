<body>
    <div id="app">
        <main role="main" class="col-md-12 ml-sm-auto col-lg-12 pt-3 px-4">
            <div>
                <nav>
                    <div class="nav nav-tabs" role="tablist">
                        <a class="nav-item nav-link active" id="home_tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">发布公告</a>
                    </div>
                </nav>


            </div>

            <div class="card mb-3">
                <div class="card-body rounded-soft bg-gradient">
                    开始时间: <input type="date" v-model="startTime"  style="margin:5px" /> <br />
                    结束时间: <input type="date" v-model="endTime" style="margin:5px" />
                    <div class="input-group mb-3" style="margin-top:5px">
                        <div class="input-group-prepend">
                            <span class="input-group-text" >标题</span>
                        </div>
                        <input type="text" class="form-control" v-model="title"  placeholder="标题" aria-label="Username" aria-describedby="basic-addon1">
                    </div>

                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text">内容</span>
                        </div>
                        <textarea class="form-control" aria-label="With textarea" v-model="content" ></textarea>
                    </div>
                    <span style="margin-top:5px">选择用户:</span> <br />
                    <button v-on:click="before()">上一页</button> <span>{{page}}/{{getPageCount}}</span>  <button v-on:click="next()">下一页</button><br />
                    <div class="table-responsive" style="width:400px;height:300px;overflow-y:scroll;overflow-x:hidden;float:left;margin-right:10px">
                        <table class="table table-striped table-sm">
                            <tbody v-for="(obj,index) in unseleTable" :key="index">
                                <tr>

                                    <td v-on:click="add_sele(index)">{{obj.VipAccountName}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="table-responsive" style="width:400px;height:300px;overflow-y:scroll;overflow-x:hidden;float:left">
                        <table class="table table-striped table-sm">
                            <tbody v-for="(obj,index) in seleTable" :key="index">
                                <tr>

                                    <td v-on:click="del_sele(index)">{{obj.VipAccountName}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <br />
                    <div>
                        <button type="button" class="btn btn-secondary btn-lg" style="margin-top:10px;margin-left:170px" v-on:click="send()">一键发布公告</button>
                    </div>
                </div>
            </div>
        </main>

    </div>
    <script>
        new Vue({
            el: "#app",
            data: {
                startTime: '',
                endTime: '',
                title: '',
                content:'',
                //所有会员
                unseleTable: [],
                //选择的会员
                seleTable: [],
                page: 1,
                rows: 20,
                count: '',
                pageCount: ''

            },
            created: function () {
                this.init()
                this.getAllVIP();
            },
            computed: {
                getPageCount() {
                    this.pageCount = Math.ceil(this.count / this.rows);
                    return this.pageCount;
                }
            },
            methods: {
                //获取该代理商下的所有vip用户
                getAllVIP() {
                    const param = {
                        page:this.page,
                        rows: this.rows
                    }
                    $.ajax({
                        url: "/VIP/GetAll",
                        data: param,
                        dataType: 'json'
                    }).then((data) => {
                        this.count = data.total;
                        this.unseleTable = data.rows;
                    });
                },
                init() {
                    let date = new Date();
                    this.startTime = date.getFullYear() + "-" + this.dateChage(date.getMonth() + 1) + "-" + this.dateChage(date.getDate());
                    let day = date.getDate();
                    date.setDate(day + 7);
                    this.endTime = date.getFullYear() + "-" + this.dateChage(date.getMonth() + 1) + "-" + this.dateChage(date.getDate());
                },
                //日期格式变换
                dateChage(date) {
                    if (date < 10)
                        date = "0" + date;
                    return date
                },
                send() {
                    let str = '';
                   
                    this.seleTable.forEach((data) => {
                        str += data.VipAccountName + ',';
                    })
                    str = str.substring(0, str.length - 1);
                    const param = {
                        title: this.title,
                        content: this.content,
                        StartDate: this.startTime,
                        EndDate: this.endTime,
                        receiver:str
                    }
                    $.ajax({
                        url: "/Notice/ReleaseNotic",
                        data: param,
                        dataType: 'json'
                    }).then((data) => {
                        alert(data.msg);
                        location.href = "/Notice/NoticRecord"
                    });
                },
                //上一页
                before() {
                    if (this.page <= 1) {
                        alert("已经是第一页了")
                    } else {
                        this.page--;
                        this.getAllVIP();
                    }
                },
                //下一页
                next() {
                    if (this.page >= this.pageCount) {
                        alert("已经是最后一页了")
                    } else {
                        this.page++;
                        this.getAllVIP();
                    }
                },
                //添加到选中事件
                add_sele(index) {
                    const item = this.unseleTable[index];
                    if (this.seleTable.indexOf(item) == -1){
                        this.seleTable.splice(0, 0, item)
                    }
                },
                del_sele(index) {
                    this.seleTable.splice(index, 1);
                }    
            }
        })


    </script>
</body>
